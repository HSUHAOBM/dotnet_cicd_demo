image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - test
  - sonar
  - notify

sonarqube:
  stage: sonar
  before_script: []  # è¦†è“‹å…¨åŸŸ before_scriptï¼Œé¿å…é‡è¤‡ build
  script:
    - dotnet tool install --global dotnet-sonarscanner
    - export PATH="$PATH:$HOME/.dotnet/tools"
    - dotnet restore DemoSolution.sln
    - dotnet sonarscanner begin /k:"$SONAR_PROJECT_KEY" /d:sonar.host.url="$SONAR_HOST_URL" /d:sonar.login="$SONAR_TOKEN"
    - dotnet build DemoSolution.sln --configuration Release --no-restore
    - dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"
  only:
    - main

test:
  stage: test
  script:
    - dotnet test --collect:"XPlat Code Coverage" --results-directory "TestResults"
    - dotnet tool install --global dotnet-reportgenerator-globaltool
    - export PATH="$PATH:/root/.dotnet/tools"
    - reportgenerator -reports:"TestResults/**/coverage.cobertura.xml" -targetdir:"coverage-report" -reporttypes:Html
    - echo "SLACK_WEBHOOK_URL=$SLACK_WEBHOOK_URL"
  artifacts:
    paths:
      - coverage-report
    when: always

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"

before_script:
  - dotnet restore DemoSolution.sln
  - dotnet build DemoSolution.sln --configuration Release --no-restore

notify:
  stage: notify
  when: on_success
  script: |
    curl -X POST -H "Content-type: application/json" --data "{
      \"text\": \"âœ… GitLab CI æˆåŠŸï¼š\\nğŸ“¦ å°ˆæ¡ˆ: $CI_PROJECT_PATH\\nğŸŒ¿ åˆ†æ”¯: $CI_COMMIT_REF_NAME\\nğŸ§‘ ä½œè€…: $GITLAB_USER_NAME\\nğŸ”— Job: $CI_JOB_URL\"
    }" $SLACK_WEBHOOK_URL

notify_failure:
  stage: notify
  when: on_failure
  script: |
    curl -X POST -H "Content-type: application/json" --data "{
      \"text\": \"âŒ GitLab CI å¤±æ•—ï¼š\\nğŸ“¦ å°ˆæ¡ˆ: $CI_PROJECT_PATH\\nğŸŒ¿ åˆ†æ”¯: $CI_COMMIT_REF_NAME\\nğŸ§‘ ä½œè€…: $GITLAB_USER_NAME\\nğŸ”— Job: $CI_JOB_URL\"
    }" $SLACK_WEBHOOK_URL
